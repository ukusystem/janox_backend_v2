import{j as e,l as S,T as j,bP as P,r as u,aF as f,G as y,H as z,a as E,v as F,w as R,n as k,bQ as T}from"./index-B2MwQ28r.js";import{A as v,S as O,P as W,F as $}from"./PageService-BmPU0Ixz.js";import{L as G}from"./LockIcon-DqzgJcKs.js";import"./Card-Czpwx8nj.js";import"./CardHeader--yi8JTB-.js";import"./CardContent-CM-ZmfFR.js";import"./Clear-CXgFz3fp.js";import"./SearchIcon-CAoQ-mMC.js";import"./groupByKey-nGMiMvM1.js";import"./Autocomplete-DO-HpUXO.js";import"./usePreviousProps-DjccIP3f.js";const b=({subTitle:c,title:d,isActive:l})=>e.jsx(e.Fragment,{children:e.jsxs(S,{direction:"row",justifyContent:"space-between",spacing:1,alignItems:"center",sx:{backgroundColor:"background.paper",borderRadius:"8px",borderWidth:1,borderStyle:"solid",borderColor:"divider",padding:1.5},children:[e.jsxs(S,{spacing:1,overflow:"hidden",children:[e.jsx(j,{variant:"subtitle1",color:"textPrimary",sx:{overflow:"hidden",textWrap:"nowrap",textOverflow:"ellipsis"},children:d}),e.jsx(j,{variant:"body1",color:"textSecondary",sx:{overflow:"hidden",textWrap:"nowrap",textOverflow:"ellipsis"},children:c})]}),e.jsx(P,{isActive:l,sx:{width:40,height:"auto"}})]})}),L=({socket:c,data:d,ctrl_id:l,state:n})=>{const[a,m]=u.useState(d);return u.useEffect(()=>{c.current&&c.current.on("pin_entrada",(x,p,h)=>{switch(h){case"update":l===x&&p.pe_id===a.pe_id&&m(p);break}})},[c]),e.jsx(e.Fragment,{children:(n===void 0||n===v.Active&&a.estado===1||n===v.Desactive&&a.estado===0)&&e.jsx(f,{size:{xs:6},children:e.jsx(b,{title:a.descripcion,subTitle:`Pin: ${a.pin}`,isActive:a.estado===1})})})},N=({socket:c,data:d,ctrl_id:l,state:n})=>{const[a,m]=u.useState(d);return u.useEffect(()=>{c.current&&c.current.on("camera",(x,p,h)=>{switch(h){case"update":l===x&&p.cmr_id===a.cmr_id&&m(p);break}})},[c]),e.jsx(e.Fragment,{children:(n===void 0||n===v.Active&&a.conectado===0||n===v.Desactive&&a.conectado===1)&&e.jsx(f,{size:{xs:6},children:e.jsx(b,{title:a.descripcion,subTitle:a.ip,isActive:a.conectado===0})})})},B=({data:c,socket:d,state:l})=>{const[n,a]=u.useState(c.controlador),[m,x]=u.useState(c.camara),[p,h]=u.useState(c.pin_entrada);return u.useEffect(()=>{d.current&&(d.current.on("pin_entrada",(r,o,s)=>{switch(s){case"add":n.ctrl_id===r&&h(t=>{const i=new Map(t);return i.set(o.pe_id,o),i});break;case"delete":n.ctrl_id===r&&h(t=>{const i=new Map(t);return i.delete(o.pe_id),i});break}}),d.current.on("camera",(r,o,s)=>{switch(s){case"add":n.ctrl_id===r&&x(t=>{const i=new Map(t);return i.set(o.cmr_id,o),i});break;case"delete":n.ctrl_id===r&&x(t=>{const i=new Map(t);return i.delete(o.cmr_id),i});break}}),d.current.on("controller",(r,o,s)=>{switch(s){case"update":n.ctrl_id===r&&a(o);break}}))},[d]),e.jsx(O,{title:n.nodo,headerIcon:n.modo===y.Seguridad?e.jsx(G,{isOpen:n.seguridad===z.Desarmado}):void 0,isalarm:"true",modo:n.modo,seguridad:n.seguridad,children:e.jsxs(S,{spacing:2,children:[e.jsxs(f,{size:{xs:12},container:!0,rowSpacing:1,columnSpacing:2,width:"100%",children:[e.jsx(f,{size:{xs:12},children:e.jsx(j,{variant:"subtitle1",children:"Placa de panel"})}),(l===void 0||l===v.Active&&n.conectado===0||l===v.Desactive&&n.conectado===1)&&e.jsx(f,{size:{xs:12},children:e.jsx(b,{title:n.nodo,subTitle:`${n.descripcion}`,isActive:n.conectado===0})})]}),p.size>0&&e.jsxs(f,{size:{xs:12},container:!0,rowSpacing:1,columnSpacing:2,width:"100%",children:[e.jsx(f,{size:{xs:12},children:e.jsx(j,{variant:"subtitle1",children:"Detectores"})}),Array.from(p).map(([r,o])=>e.jsx(L,{ctrl_id:n.ctrl_id,data:o,socket:d,state:l},r))]}),m.size>0&&e.jsxs(f,{size:{xs:12},container:!0,rowSpacing:1,columnSpacing:2,width:"100%",marginTop:1,children:[e.jsx(f,{size:{xs:12},children:e.jsx(j,{variant:"subtitle1",children:"CÃ¡maras"})}),Array.from(m).map(([r,o])=>e.jsx(N,{ctrl_id:n.ctrl_id,data:o,socket:d,state:l},r))]})]})})},H=()=>{const[c,d]=u.useState(new Map),[l,n]=u.useState(new Map),a=u.useRef(null),{rgn_id:m,ctrl_id:x,state:p}=E(r=>r.alarmServiceStore),h=u.useMemo(()=>{const r=new Map;for(const[,s]of c){const t=s.controlador.rgn_id,i=s.controlador.ctrl_id;if(m!==void 0&&String(t)!==String(m)||x!==void 0&&String(i)!==String(x))continue;const g=r.get(t);g===void 0?r.set(t,[s]):g.push(s)}return Array.from(r.values()).reduce((s,t)=>{const i=s,g=t;if(g[0]){const w=l.get(g[0].controlador.rgn_id);w!==void 0&&i.push({rgn_id:w.rgn_id,region:w.region,nodos:r.get(w.rgn_id)??[]})}return i},[])},[c,m,x]);return u.useEffect(()=>(a.current||(a.current=F(`${R}/alarm_notification`,{withCredentials:!0})),a.current.on("initial_data",(r,o)=>{const s=new Map;o.forEach(i=>{s.set(i.rgn_id,i)}),n(s);const t=new Map;Object.values(r).forEach(i=>{const{camara:g,controlador:w,pin_entrada:M}=i,A=g.map(_=>[_.cmr_id,_]),C=M.map(_=>[_.pe_id,_]),I={controlador:w,camara:new Map(A),pin_entrada:new Map(C)};t.set(w.ctrl_id,I)}),d(t)}),a.current.on("region",(r,o)=>{n(s=>{const t=new Map(s);return t.set(r,o),t})}),a.current.on("controller",(r,o,s)=>{switch(s){case"add":d(t=>{if(!t.has(r)){const i=new Map([...t]);return i.set(r,{controlador:o,camara:new Map,pin_entrada:new Map}),i}return t});break;case"delete":d(t=>{if(t.has(r)){const i=new Map([...t]);return i.delete(r),i}return t});break}}),()=>{a.current&&(a.current.disconnect(),a.current=null)}),[]),e.jsx(e.Fragment,{children:e.jsx(S,{spacing:2,overflow:"hidden",children:h.map(r=>e.jsxs(S,{overflow:"hidden",children:[e.jsx(j,{variant:"h5",children:r.region}),e.jsx(k,{sx:{width:"100%",height:"100%"},children:e.jsx(S,{spacing:2,direction:"row",py:2,children:r.nodos.map(o=>e.jsx(B,{data:o,socket:a,state:p===void 0?void 0:Number(p)},o.controlador.ctrl_id))})})]},r.rgn_id))})})},re=()=>e.jsx(W,{title:"Alarmas",filter:e.jsx($,{storeSelector:c=>c.alarmServiceStore,updateStoreAction:T,activeState:!0}),children:e.jsx(H,{})});export{re as default};
